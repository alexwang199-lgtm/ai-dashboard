<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蒼龍計畫 AI 戰情室 (v2.1 - 固定網域版)</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .log-entry { font-family: 'Consolas', 'Monaco', monospace; }
        @keyframes flash-green { 0% { background-color: rgba(34, 197, 94, 0.3); } 100% { background-color: transparent; } }
        @keyframes flash-red { 0% { background-color: rgba(239, 68, 68, 0.3); } 100% { background-color: transparent; } }
        .flash-up { animation: flash-red 0.5s ease-out; }
        .flash-down { animation: flash-green 0.5s ease-out; }
        .pnl-value { transition: color 0.3s ease; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- 組件：狀態指示燈 ---
        const StatusBadge = ({ connected }) => (
            <div className={`flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold border ${connected ? 'bg-green-900/30 border-green-500 text-green-400' : 'bg-red-900/30 border-red-500 text-red-400'}`}>
                <div className={`w-2 h-2 rounded-full ${connected ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                {connected ? '系統連線正常 (Static Domain)' : '等待系統連線...'}
            </div>
        );

        // --- 組件：微型走勢圖 (SVG Sparkline) ---
        const Sparkline = ({ data, color }) => {
            if (!data || data.length < 2) return <div className="h-full w-full bg-slate-800/30 rounded"></div>;
            
            const width = 100;
            const height = 40;
            const prices = data.map(d => d.price);
            const min = Math.min(...prices);
            const max = Math.max(...prices);
            const range = max - min || 1; 

            const points = data.map((d, i) => {
                const x = (i / (data.length - 1)) * width;
                const y = height - ((d.price - min) / range) * height; 
                return `${x},${y}`;
            }).join(' ');

            return (
                <div className="h-12 w-full overflow-hidden">
                    <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full" preserveAspectRatio="none">
                        <polyline
                            fill="none"
                            stroke={color}
                            strokeWidth="2"
                            points={points}
                            vectorEffect="non-scaling-stroke" 
                        />
                    </svg>
                </div>
            );
        };

        // --- 組件：損益卡片 ---
        const PnLCard = ({ title, value, subValue, isCurrency = true, icon, colorOverride }) => {
            const displayValue = isCurrency && value !== null ? Math.floor(value).toLocaleString() : (value ?? "-");
            const textColor = colorOverride ? colorOverride : (value > 0 ? 'text-red-400' : (value < 0 ? 'text-green-400' : 'text-slate-200'));
            
            return (
                <div className="bg-slate-800/50 border border-slate-700 p-4 rounded-xl flex items-center justify-between shadow-lg backdrop-blur-sm">
                    <div>
                        <div className="text-slate-400 text-xs font-medium mb-1 flex items-center gap-1">
                            {icon} {title}
                        </div>
                        <div className={`text-2xl font-bold font-mono pnl-value ${isCurrency ? textColor : 'text-slate-100'}`}>
                            {value > 0 && isCurrency ? '+' : ''}{displayValue}
                        </div>
                        {subValue && (
                            <div className="text-xs text-slate-500 mt-1">{subValue}</div>
                        )}
                    </div>
                </div>
            );
        };

        // --- 組件：主要儀表板 ---
        function App() {
            const [connected, setConnected] = useState(false);
            const [marketData, setMarketData] = useState({ marketBreadth: {}, futures: {} });
            
            const [tickHistory, setTickHistory] = useState({});
            const [currentQuotes, setCurrentQuotes] = useState({});
            const [logs, setLogs] = useState([]);
            const logEndRef = useRef(null);
            
            // 損益與持倉狀態
            const [accountStats, setAccountStats] = useState({
                realized: 0,
                trades: 0,
                positions_count: 0,
                unrealized: 0
            });
            
            // 本地持倉清單 (用於計算未實現損益)
            const [positions, setPositions] = useState([]);

            const ws = useRef(null);

            // 自動滾動日誌
            useEffect(() => {
                logEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [logs]);

            // 計算未實現損益 (當報價或持倉變動時)
            useEffect(() => {
                if (positions.length === 0) {
                    setAccountStats(prev => ({ ...prev, unrealized: 0 }));
                    return;
                }

                let totalUnrealized = 0;
                positions.forEach(pos => {
                    const quote = currentQuotes[pos.s];
                    if (quote && quote.price) {
                        const currentPrice = quote.price;
                        const entryPrice = pos.p;
                        const qty = pos.q;
                        // 台股一張 1000 股
                        const diff = (currentPrice - entryPrice) * qty * 1000;
                        if (pos.type === 'long') totalUnrealized += diff;
                        else totalUnrealized -= diff;
                    }
                });
                
                setAccountStats(prev => ({ ...prev, unrealized: totalUnrealized }));

            }, [currentQuotes, positions]);

            // WebSocket 連線
            useEffect(() => {
                const connect = () => {
                    // [Ngrok 固定網域設定] 
                    // 使用您的固定網域：superterrestrial-sadie-exteriorly.ngrok-free.dev
                    ws.current = new WebSocket("wss://superterrestrial-sadie-exteriorly.ngrok-free.dev/ws");

                    ws.current.onopen = () => {
                        setConnected(true);
                        addLog("System", "已連接至數據橋接器 (Dashboard Bridge)");
                    };

                    ws.current.onclose = () => {
                        setConnected(false);
                        setTimeout(connect, 3000); // 斷線重連
                    };

                    ws.current.onmessage = (event) => {
                        try {
                            const msg = JSON.parse(event.data);
                            handleData(msg);
                        } catch (e) { console.error(e); }
                    };
                };
                connect();
                return () => ws.current?.close();
            }, []);

            const addLog = (source, msg) => {
                setLogs(prev => [...prev.slice(-99), { time: new Date().toLocaleTimeString(), source, msg }]);
            };

            const handleData = (msg) => {
                const { type, data } = msg;

                if (type === "DASHBOARD_MARKET") {
                    setMarketData(prev => ({
                        ...prev,
                        marketBreadth: data.marketBreadth || prev.marketBreadth,
                        futures: { ...prev.futures, ...data.futures }
                    }));
                } 
                else if (type === "DASHBOARD_SNAPSHOT") {
                    // 1. 更新已實現損益與交易次數
                    if (data.pnl) {
                        setAccountStats(prev => ({ 
                            ...prev, 
                            realized: data.pnl.realized, 
                            trades: data.pnl.trades_count 
                        }));
                    }
                    // 2. 更新持倉 (用於計算未實現)
                    if (data.positions) {
                        setPositions(data.positions);
                        setAccountStats(prev => ({ 
                            ...prev, 
                            positions_count: data.positions.length 
                        }));
                    }
                    // 3. 更新報價 (補足 Tick 沒收到的部分)
                    if (data.quotes) {
                        const now = Date.now();
                        setCurrentQuotes(prev => {
                            const next = { ...prev };
                            data.quotes.forEach(q => {
                                if (!next[q.s] || (now - next[q.s].last_update > 2000)) {
                                    next[q.s] = {
                                        name: q.n, // 更新股名
                                        price: q.p,
                                        volume: q.v,
                                        change: q.chg,
                                        last_update: now
                                    };
                                }
                            });
                            return next;
                        });
                    }
                }
                else if (type === "DASHBOARD_TICKS") {
                    if (Array.isArray(data)) {
                        const now = Date.now();
                        data.forEach(tick => {
                            const symbol = tick.s;
                            const price = tick.p;
                            const volume = tick.v;
                            const side = tick.sd;
                            const name = tick.n;
                            
                            setCurrentQuotes(prev => {
                                const prevQuote = prev[symbol] || { volume: 0, price: price, name: symbol };
                                
                                return {
                                    ...prev,
                                    [symbol]: {
                                        name: name || prevQuote.name || symbol,
                                        price: price,
                                        volume: volume, 
                                        change: prevQuote.change || 0,
                                        side: side,
                                        last_update: now
                                    }
                                };
                            });

                            setTickHistory(prev => {
                                const oldHistory = prev[symbol] || [];
                                const newHistory = [...oldHistory, { time: now, price: price }];
                                if (newHistory.length > 30) newHistory.shift();
                                return { ...prev, [symbol]: newHistory };
                            });
                        });
                    }
                }
                else if (type === "DASHBOARD_LOGS") {
                    if (Array.isArray(data)) {
                        data.forEach(logStr => {
                            const match = logStr.match(/^\[(.*?)\] (.*)/);
                            if (match) addLog("AI Core", match[2]);
                            else addLog("AI Core", logStr);
                        });
                    }
                }
            };

            const sentiment = useMemo(() => {
                const breadth = marketData.marketBreadth || {up:0, down:0};
                const total = (breadth.up || 0) + (breadth.down || 0);
                if (total === 0) return { text: "等待數據", color: "text-slate-400", bar: 50 };
                const ratio = (breadth.up / total) * 100;
                return {
                    text: ratio > 60 ? "多方強勢" : ratio < 40 ? "空方主導" : "多空拉鋸",
                    color: ratio > 60 ? "text-red-400" : ratio < 40 ? "text-green-400" : "text-yellow-400",
                    bar: ratio
                };
            }, [marketData]);

            // 排序股票 (依最近更新時間)
            const sortedStocks = useMemo(() => {
                return Object.keys(currentQuotes).sort((a, b) => {
                    return currentQuotes[b].last_update - currentQuotes[a].last_update;
                }).slice(0, 10);
            }, [currentQuotes]);

            return (
                <div className="min-h-screen p-2 md:p-4 max-w-[1600px] mx-auto space-y-4">
                    {/* Header */}
                    <header className="flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-800/50 p-3 rounded-xl border border-slate-700 backdrop-blur-md sticky top-0 z-50">
                        <div className="flex items-center gap-3">
                            <div className="bg-blue-600 p-2 rounded-lg shadow-lg shadow-blue-500/20">
                                <i data-lucide="activity" className="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-cyan-300">
                                    蒼龍計畫 AI 戰情室
                                </h1>
                                <p className="text-xs text-slate-400 font-mono">v72.60 | Static Domain Active</p>
                            </div>
                        </div>
                        <StatusBadge connected={connected} />
                    </header>

                    {/* PnL Status */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <PnLCard 
                            title="今日已實現損益 (Realized)" 
                            value={accountStats.realized} 
                            subValue="已結算獲利"
                            icon={<i data-lucide="dollar-sign" className="w-4 h-4"></i>}
                        />
                        <PnLCard 
                            title="帳面未實現損益 (Unrealized)" 
                            value={accountStats.unrealized} 
                            subValue="庫存浮動損益"
                            icon={<i data-lucide="activity" className="w-4 h-4"></i>}
                        />
                        
                        <div className="bg-slate-800/50 border border-slate-700 p-4 rounded-xl flex items-center justify-between shadow-lg">
                            <div>
                                <div className="text-slate-400 text-xs font-medium mb-1 flex items-center gap-1">
                                    <i data-lucide="bar-chart" className="w-4 h-4"></i> 交易次數
                                </div>
                                <div className="flex items-baseline gap-2">
                                    <span className="text-2xl font-bold font-mono text-white">{accountStats.trades}</span>
                                    <span className="text-xs text-slate-500">筆</span>
                                </div>
                            </div>
                        </div>

                        <div className="bg-slate-800/50 border border-slate-700 p-4 rounded-xl flex items-center justify-between shadow-lg">
                            <div>
                                <div className="text-slate-400 text-xs font-medium mb-1 flex items-center gap-1">
                                    <i data-lucide="layers" className="w-4 h-4"></i> 目前持倉
                                </div>
                                <div className="flex items-baseline gap-2">
                                    <span className="text-2xl font-bold font-mono text-blue-400">{accountStats.positions_count}</span>
                                    <span className="text-xs text-slate-500">檔庫存</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Market Overview */}
                    <div className="grid grid-cols-1 md:grid-cols-12 gap-4">
                        <div className="md:col-span-3 bg-slate-800/50 border border-slate-700 p-4 rounded-xl flex flex-col justify-between">
                            <div className="flex justify-between items-start mb-2">
                                <h3 className="text-slate-400 text-sm font-medium">市場多空廣度</h3>
                                <span className={`text-sm font-bold ${sentiment.color}`}>{sentiment.text}</span>
                            </div>
                            <div className="flex items-end gap-2 mb-2">
                                <span className="text-2xl font-bold text-red-400">{marketData.marketBreadth?.up || 0}</span>
                                <div className="flex-1 mx-2 h-12 flex items-end gap-1">
                                    <div className="w-full bg-red-500/20 rounded-t-sm relative h-full">
                                        <div className="absolute bottom-0 w-full bg-red-500 transition-all duration-500" style={{height: `${sentiment.bar}%`}}></div>
                                    </div>
                                    <div className="w-full bg-green-500/20 rounded-t-sm relative h-full">
                                        <div className="absolute bottom-0 w-full bg-green-500 transition-all duration-500" style={{height: `${100 - sentiment.bar}%`}}></div>
                                    </div>
                                </div>
                                <span className="text-2xl font-bold text-green-400">{marketData.marketBreadth?.down || 0}</span>
                            </div>
                        </div>

                        <div className="md:col-span-9 bg-slate-800/50 border border-slate-700 p-4 rounded-xl">
                            <div className="grid grid-cols-3 gap-4 h-full">
                                {Object.keys(marketData.futures || {}).length === 0 ? (
                                    <div className="col-span-3 flex items-center justify-center text-slate-500">等待期貨數據連線...</div>
                                ) : (
                                    Object.entries(marketData.futures).map(([symbol, f]) => (
                                        <div key={symbol} className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50 flex flex-col justify-center">
                                            <div className="flex justify-between items-baseline mb-1">
                                                <span className="text-sm font-bold text-slate-300">{symbol}</span>
                                                <span className={`text-sm font-mono ${f.ChangeRate >= 0 ? 'text-red-400' : 'text-green-400'}`}>
                                                    {f.ChangeRate > 0 ? '+' : ''}{(f.ChangeRate || 0).toFixed(2)}%
                                                </span>
                                            </div>
                                            <div className="flex justify-between items-end">
                                                <span className="text-2xl font-mono font-bold text-white">{(f.last_price || 0).toFixed(0)}</span>
                                                <div className="text-right">
                                                    <div className="text-[10px] text-slate-500">多空力道</div>
                                                    <div className={`text-xs font-bold ${f.pressure_ratio > 1 ? 'text-red-400' : 'text-green-400'}`}>{(f.pressure_ratio || 1).toFixed(2)}</div>
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </div>

                    {/* High Frequency Pool */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <div className="lg:col-span-2 bg-slate-800/50 border border-slate-700 rounded-xl flex flex-col overflow-hidden h-[600px]">
                            <div className="p-3 border-b border-slate-700 flex justify-between items-center bg-slate-800">
                                <h3 className="font-bold flex items-center gap-2 text-white">
                                    <i data-lucide="zap" className="w-4 h-4 text-yellow-400"></i>
                                    高頻監控池 (即時跳動)
                                </h3>
                                <span className="text-xs bg-slate-700 px-2 py-1 rounded text-slate-300">Tick Stream</span>
                            </div>
                            
                            <div className="flex-1 p-2 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-2 content-start">
                                {sortedStocks.length === 0 ? (
                                    <div className="col-span-2 h-64 flex flex-col items-center justify-center text-slate-500">
                                        <i data-lucide="loader" className="w-8 h-8 animate-spin mb-2"></i>
                                        <p>等待即時 Tick 數據流...</p>
                                    </div>
                                ) : (
                                    sortedStocks.map(symbol => {
                                        const quote = currentQuotes[symbol] || {};
                                        const history = tickHistory[symbol] || [];
                                        const color = (history[history.length-1]?.price >= history[0]?.price) ? '#ef4444' : '#22c55e';
                                        const flashClass = quote.side === 1 ? 'flash-up' : (quote.side === -1 ? 'flash-down' : '');

                                        return (
                                            <div key={symbol} className={`bg-slate-900/80 p-3 rounded-lg border border-slate-700/50 flex flex-col gap-2 transition-colors duration-300 ${flashClass}`}>
                                                <div className="flex justify-between items-center">
                                                    <div className="flex items-baseline gap-2">
                                                        <span className="text-lg font-bold text-white font-mono">{symbol}</span>
                                                        <span className="text-xs text-slate-400">{quote.name}</span>
                                                    </div>
                                                    <div className="text-right">
                                                        <span className={`text-xl font-mono font-bold text-white`}>
                                                            {quote.price?.toFixed(1)}
                                                        </span>
                                                    </div>
                                                </div>

                                                <div className="flex-1 w-full bg-slate-950/30 rounded border border-slate-800/50 relative">
                                                    <Sparkline data={history} color={color} />
                                                </div>

                                                <div className="flex justify-between items-center text-xs">
                                                    <span className="text-slate-500 font-mono">
                                                        Vol: <span className="text-slate-300">{quote.volume}</span>
                                                    </span>
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        </div>

                        {/* Logs */}
                        <div className="bg-black/40 border border-slate-700 rounded-xl flex flex-col overflow-hidden font-mono text-sm h-[600px]">
                            <div className="p-3 border-b border-slate-700 bg-slate-900/50 flex justify-between items-center">
                                <h3 className="text-slate-400 font-medium text-xs uppercase tracking-wider">AI Decision Logs</h3>
                                <div className="flex gap-1"><div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div></div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-2 scrollbar-hide">
                                {logs.map((log, idx) => (
                                    <div key={idx} className="log-entry text-xs break-all border-l-2 border-slate-700 pl-2 py-1">
                                        <div className="text-slate-500 mb-0.5">[{log.time}] <span className={log.source === "AI Core" ? "text-blue-400" : "text-yellow-500"}>{log.source}</span></div>
                                        <div className={log.msg.includes("CRITICAL") || log.msg.includes("錯誤") ? "text-red-400" : log.msg.includes("進場") ? "text-yellow-300 font-bold" : log.msg.includes("平倉") ? "text-purple-300 font-bold" : "text-slate-300"}>
                                            {log.msg}
                                        </div>
                                    </div>
                                ))}
                                <div ref={logEndRef} />
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
        setTimeout(() => lucide.createIcons(), 100);
    </script>
</body>
</html>